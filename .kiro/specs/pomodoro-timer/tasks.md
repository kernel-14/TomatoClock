# 实施计划：番茄钟应用

## 概述

本实施计划将番茄钟应用分解为可执行的编码任务。应用基于Electron + React + TypeScript构建，采用主进程和渲染进程分离的架构。每个任务都是离散的、可管理的编码步骤，按照从核心功能到UI集成的顺序组织。

## 任务列表

- [x ] 1. 项目初始化和基础架构搭建
  - 创建Electron + React + TypeScript项目结构
  - 配置Vite构建工具
  - 配置Vitest测试框架和fast-check库
  - 设置ESLint和Prettier代码规范
  - 创建基础目录结构（src/main, src/renderer, src/shared）
  - _需求：需求 8.1_

- [ ] 2. 数据服务层实现
  - [x] 2.1 实现SQLite数据库初始化和模式创建
    - 创建DataService类和数据库连接管理
    - 实现数据库表创建（focus_sessions, app_settings）
    - 实现数据库索引创建
    - 添加数据库版本管理和迁移支持
    - _需求：需求 3.1, 3.2_
  
  - [x] 2.2 编写数据库初始化的属性测试
    - **属性 8：损坏数据恢复能力**
    - **验证需求：需求 3.3**
  
  - [x] 2.3 实现专注时段数据的CRUD操作
    - 实现saveFocusSession方法（插入和更新）
    - 实现getFocusSessions方法（按日期查询）
    - 实现数据验证逻辑
    - _需求：需求 2.2, 2.4, 3.1_
  
  - [x] 2.4 编写专注时段数据往返的属性测试
    - **属性 7：专注时段数据往返一致性**
    - **验证需求：需求 2.2, 2.4, 3.1, 3.2**
  
  - [x] 2.5 实现应用设置的保存和加载
    - 实现saveSettings方法
    - 实现loadSettings方法
    - 实现设置默认值处理
    - _需求：需求 6.3, 6.4_
  
  - [x] 2.6 编写应用设置往返的属性测试
    - **属性 14：应用设置往返一致性**
    - **验证需求：需求 6.3, 6.4**
  
  - [x] 2.7 编写数据库错误处理的单元测试
    - 测试写入失败场景
    - 测试查询失败场景
    - 测试连接失败场景
    - _需求：需求 3.4_

- [x] 3. 检查点 - 确保数据层测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 4. 计时器服务实现
  - [x] 4.1 实现TimerService核心逻辑
    - 创建TimerService类和状态管理
    - 实现start方法（开始计时）
    - 实现pause和resume方法
    - 实现reset方法
    - 实现tick事件发射（每秒更新）
    - 实现complete事件发射（倒计时结束）
    - _需求：需求 1.1, 1.2, 1.3, 1.4, 1.5_
  
  - [x] 4.2 编写计时器状态转换的属性测试
    - **属性 1：计时器状态转换正确性**
    - **验证需求：需求 1.1**
  
  - [x] 4.3 编写计时器递减的属性测试
    - **属性 2：计时器递减正确性**
    - **验证需求：需求 1.2**
  
  - [x] 4.4 编写计时器完成事件的属性测试
    - **属性 3：计时器完成事件触发**
    - **验证需求：需求 1.3**
  
  - [x] 4.5 编写暂停不变性的属性测试
    - **属性 4：暂停保持不变性**
    - **验证需求：需求 1.4**
  
  - [x] 4.6 编写重置功能的属性测试
    - **属性 5：重置恢复初始值**
    - **验证需求：需求 1.5**

- [ ] 5. 任务名称验证和处理
  - [x] 5.1 实现任务名称验证逻辑
    - 创建validateTaskName函数
    - 实现空白字符检测和默认值替换
    - 实现长度限制验证（最大100字符）
    - _需求：需求 2.3_
  
  - [x] 5.2 编写空任务名称处理的属性测试
    - **属性 6：空任务名称默认值**
    - **验证需求：需求 2.3**

- [ ] 6. 统计模块实现
  - [x] 6.1 实现StatisticsModule计算逻辑
    - 创建StatisticsModule类
    - 实现calculateDailyStats方法（计算单日统计）
    - 实现calculateTodayStats方法
    - 实现日期过滤逻辑
    - 实现时间排序逻辑
    - _需求：需求 4.1, 4.2, 4.3, 4.4_
  
  - [x] 6.2 编写统计计算正确性的属性测试
    - **属性 10：统计数据计算正确性**
    - **验证需求：需求 4.1, 4.2**
  
  - [x] 6.3 编写时间排序的属性测试
    - **属性 11：时间排序不变性**
    - **验证需求：需求 4.3**
  
  - [x] 6.4 编写日期过滤的属性测试
    - **属性 12：日期过滤正确性**
    - **验证需求：需求 4.4**
  
  - [x] 6.5 编写空数据处理的单元测试
    - 测试没有数据时返回空统计
    - _需求：需求 4.5_

- [x] 7. 检查点 - 确保核心业务逻辑测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 8. 主进程窗口管理器实现
  - [x] 8.1 实现WindowManager类
    - 创建WindowManager类
    - 实现createMainWindow方法（创建无边框悬浮窗）
    - 配置窗口属性（大小、透明、可拖动）
    - 实现setAlwaysOnTop方法
    - 实现setOpacity方法
    - _需求：需求 5.1, 6.1, 6.2, 7.1, 7.2_
  
  - [x] 8.2 实现窗口位置保存和恢复
    - 实现saveWindowPosition方法
    - 实现restoreWindowPosition方法
    - 集成DataService保存位置到设置
    - _需求：需求 5.2, 5.3_
  
  - [x] 8.3 编写窗口位置往返的属性测试
    - **属性 13：窗口位置往返一致性**
    - **验证需求：需求 5.2, 5.3**
  
  - [x] 8.4 编写置顶状态设置的属性测试
    - **属性 15：置顶状态设置正确性**
    - **验证需求：需求 6.1, 6.2**

- [ ] 9. 通知服务实现
  - [x] 9.1 实现NotificationService类
    - 创建NotificationService类
    - 实现showNotification方法（使用Electron Notification API）
    - 实现playSound方法（播放提示音）
    - 实现权限检查和请求
    - _需求：需求 1.3_
  
  - [x] 9.2 编写通知服务的单元测试
    - 测试通知显示
    - 测试提示音播放
    - _需求：需求 1.3_

- [ ] 10. 系统托盘实现
  - [x] 10.1 实现TrayManager类
    - 创建TrayManager类
    - 实现托盘图标创建
    - 实现右键菜单（显示/隐藏、退出）
    - 实现托盘图标点击事件处理
    - _需求：需求 8.5_
  
  - [x] 10.2 编写托盘功能的单元测试
    - 测试托盘创建
    - 测试菜单项功能
    - _需求：需求 8.5_

- [ ] 11. 主进程IPC通信层实现
  - [x] 11.1 定义IPC通信协议
    - 创建shared/ipc-channels.ts定义通道名称
    - 创建shared/types.ts定义数据类型
    - _需求：所有需求_
  
  - [x] 11.2 实现主进程IPC处理器
    - 实现计时器相关IPC处理（start, pause, resume, reset）
    - 实现数据查询IPC处理（getFocusSessions, getStatistics）
    - 实现设置相关IPC处理（saveSettings, loadSettings）
    - 实现窗口控制IPC处理（setAlwaysOnTop, setOpacity）
    - 使用contextBridge安全暴露API
    - _需求：所有需求_

- [x] 12. 检查点 - 确保主进程功能完整
  - 确保所有测试通过，如有问题请询问用户

- [ ] 13. React UI组件实现 - 计时器界面
  - [x] 13.1 实现TimerDisplay组件
    - 创建TimerDisplay组件显示剩余时间
    - 实现时间格式化（MM:SS）
    - 实现动态样式（运行/暂停/完成状态）
    - _需求：需求 1.2, 7.5_
  
  - [x] 13.2 实现TimerControls组件
    - 创建TimerControls组件（开始/暂停/重置按钮）
    - 实现按钮状态管理（根据计时器状态禁用/启用）
    - 实现图标按钮样式
    - _需求：需求 1.1, 1.4, 1.5_
  
  - [x] 13.3 实现TaskInput组件
    - 创建TaskInput组件（任务名称输入框）
    - 实现输入验证和默认值处理
    - 实现字符计数显示
    - _需求：需求 2.1, 2.2, 2.3_
  
  - [x] 13.4 实现MainTimer容器组件
    - 创建MainTimer组件整合计时器UI
    - 实现计时器状态管理（使用React hooks）
    - 实现IPC通信调用
    - 实现计时器事件监听和UI更新
    - _需求：需求 1.1, 1.2, 1.3_
  
  - [x] 13.5 编写计时器UI组件的单元测试
    - 测试TimerDisplay渲染
    - 测试TimerControls交互
    - 测试TaskInput验证
    - _需求：需求 1.1, 1.2, 2.3_

- [ ] 14. React UI组件实现 - 统计界面
  - [x] 14.1 实现StatsList组件
    - 创建StatsList组件显示专注记录列表
    - 实现记录项渲染（任务名称、时长、时间）
    - 实现空状态显示
    - _需求：需求 4.3, 4.5_
  
  - [x] 14.2 实现StatsHeader组件
    - 创建StatsHeader组件显示统计摘要
    - 显示总时长和时段数量
    - 实现日期选择器
    - _需求：需求 4.1, 4.2, 4.4_
  
  - [x] 14.3 实现Statistics容器组件
    - 创建Statistics组件整合统计UI
    - 实现数据加载和状态管理
    - 实现IPC通信调用
    - 实现日期切换逻辑
    - _需求：需求 4.1, 4.2, 4.3, 4.4_
  
  - [x] 14.4 编写统计UI组件的单元测试
    - 测试StatsList渲染
    - 测试StatsHeader显示
    - 测试空状态处理
    - _需求：需求 4.3, 4.5_

- [ ] 15. React UI组件实现 - 设置界面
  - [x] 15.1 实现Settings组件
    - 创建Settings组件
    - 实现置顶开关控件
    - 实现透明度滑块控件
    - 实现默认时长设置
    - 实现提示音开关
    - 实现设置保存逻辑
    - _需求：需求 6.1, 6.2, 7.1, 7.2_
  
  - [x] 15.2 编写设置UI组件的单元测试
    - 测试设置项渲染
    - 测试设置保存
    - _需求：需求 6.3, 6.4_

- [ ] 16. UI样式和动画实现
  - [x] 16.1 实现悬浮岛样式
    - 使用Tailwind CSS创建圆角卡片样式
    - 实现阴影效果
    - 实现半透明背景
    - 实现响应式布局
    - _需求：需求 7.3_
  
  - [x] 16.2 实现透明度过渡动画
    - 实现鼠标悬停时的透明度变化
    - 实现焦点状态的透明度变化
    - 使用CSS transition实现平滑过渡
    - _需求：需求 5.5, 7.1, 7.2_
  
  - [x] 16.3 编写透明度状态转换的属性测试
    - **属性 16：透明度状态转换正确性**
    - **验证需求：需求 5.5, 7.1, 7.2**

- [ ] 17. 应用生命周期管理
  - [x] 17.1 实现应用启动逻辑
    - 在main.ts中实现应用初始化流程
    - 实现数据库初始化
    - 实现窗口创建和显示
    - 实现设置加载和应用
    - 实现错误处理和日志记录
    - _需求：需求 8.1, 8.2_
  
  - [x] 17.2 实现应用关闭逻辑
    - 实现关闭前数据保存
    - 实现运行中计时器的确认对话框
    - 实现窗口位置保存
    - 实现资源清理
    - _需求：需求 8.3, 8.4_
  
  - [x] 17.3 编写应用生命周期的单元测试
    - 测试初始化流程
    - 测试关闭流程
    - 测试错误处理
    - _需求：需求 8.2, 8.3_

- [ ] 18. 错误处理和日志系统
  - [x] 18.1 实现日志服务
    - 创建Logger类
    - 实现日志文件写入（JSON Lines格式）
    - 实现日志轮转（每天一个文件）
    - 实现日志级别过滤
    - _需求：需求 3.3, 8.2_
  
  - [x] 18.2 集成错误处理到各模块
    - 在DataService中添加错误捕获和日志
    - 在TimerService中添加错误捕获和日志
    - 在WindowManager中添加错误捕获和日志
    - 在渲染进程中添加全局错误处理
    - _需求：需求 3.4, 8.2_
  
  - [x] 18.3 编写错误处理的单元测试
    - 测试各种错误场景
    - 测试日志记录
    - _需求：需求 3.3, 3.4, 8.2_

- [x] 19. 检查点 - 确保所有功能集成完成
  - 确保所有测试通过，如有问题请询问用户

- [ ] 20. 集成测试和端到端测试
  - [x] 20.1 编写计时器完整流程的集成测试
    - 测试从启动到完成的完整流程
    - 测试数据保存和加载
    - _需求：需求 1.1, 1.2, 1.3, 2.4, 3.1_
  
  - [x] 20.2 编写统计功能的集成测试
    - 测试多个时段的统计计算
    - 测试日期过滤和排序
    - _需求：需求 4.1, 4.2, 4.3, 4.4_
  
  - [x] 20.3 编写设置持久化的集成测试
    - 测试设置保存和恢复
    - 测试窗口状态恢复
    - _需求：需求 6.3, 6.4, 5.3_

- [ ] 21. 打包和分发配置
  - [x] 21.1 配置electron-builder
    - 创建electron-builder配置文件
    - 配置Windows安装程序生成
    - 配置应用图标和元数据
    - 配置文件关联和快捷方式
    - _需求：需求 8.1_
  
  - [x] 21.2 配置自动更新
    - 集成electron-updater
    - 实现更新检查逻辑
    - 实现更新下载和安装提示
    - _需求：需求 8.1_
  
  - [x] 21.3 创建构建脚本
    - 创建package.json构建脚本
    - 创建开发环境启动脚本
    - 创建测试运行脚本
    - _需求：需求 8.1_

- [x] 22. 最终检查点 - 完整应用测试
  - 确保所有测试通过，如有问题请询问用户
  - 手动测试所有功能
  - 验证打包后的应用可以正常运行

## 注意事项

- 每个任务都引用了具体的需求以便追溯
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边缘情况
- 所有测试任务都是必需的，以确保代码质量
